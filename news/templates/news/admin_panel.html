{% extends "default.html" %}
{% load i18n %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center">{% trans "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" %}</h2>

    <div class="text-center mb-4">
        <a href="{% url 'news_create' %}" class="btn btn-success">{% trans "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å" %}</a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>{% trans "ID" %}</th>
                    <th>{% trans "–ó–∞–≥–æ–ª–æ–≤–æ–∫" %}</th>
                    <th>{% trans "–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è" %}</th>
                    <th>{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts %}
                <tr>
                    <td>{{ post.id }}</td>
                    <td>
                        <a href="{% url 'news_detail' post.id %}" class="text-decoration-none">
                            üìé {{ post.title }}
                        </a>
                    </td>
                    <td>{{ post.time_created }}</td>
                    <td>
                        <a href="{% url 'news_edit' post.id %}" class="btn btn-warning btn-sm">{% trans "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" %}</a>
                        <button class="btn btn-danger btn-sm delete-btn" data-post-id="{{ post.id }}">
                            {% trans "–£–¥–∞–ª–∏—Ç—å" %}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è" %}</h5>
                <button type="button" class="btn-close macos-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç–∞—Ç—å—é?" %}</p>
                <input type="password" id="deletePassword" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <div class="text-danger mt-2" id="deleteError"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "–û—Ç–º–µ–Ω–∞" %}
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>{% trans "–£–¥–∞–ª–∏—Ç—å" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedPostId = null;

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function () {
                selectedPostId = this.getAttribute("data-post-id");
                document.getElementById("deleteError").innerText = "";
                document.getElementById("deletePassword").value = "";
                document.getElementById("confirmDeleteBtn").disabled = true;
                new bootstrap.Modal(document.getElementById("deleteModal")).show();
            });
        });

        document.getElementById("deletePassword").addEventListener("input", function () {
            document.getElementById("confirmDeleteBtn").disabled = this.value.trim() === "";
        });

        document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
            const password = document.getElementById("deletePassword").value;
            if (!selectedPostId) return;

            fetch(`/news/${selectedPostId}/delete/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-Requested-With": "XMLHttpRequest"
                },
                credentials: "same-origin",
                body: `password=${encodeURIComponent(password)}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    document.getElementById("deleteError").innerText = data.error;
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞:", error));
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    .btn-close.macos-close {
        width: 14px;
        height: 14px;
        background: none;
        border: none;
        opacity: 0.7;
        transition: opacity 0.3s ease-in-out;
        position: absolute;
        right: 15px;
        top: 15px;
    }

    .btn-close.macos-close:hover {
        opacity: 1;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

{% endblock %}